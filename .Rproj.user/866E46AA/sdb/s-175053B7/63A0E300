{
    "collab_server" : "",
    "contents" : "#calc_lib\n\nname.var <- function(ticker,new_name) { #always name last column\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  cmd_string <- paste(\"col <- ncol(\",ve.xls,\")\",sep=\"\")\n  eval(parse(text=cmd_string))\n  cmd_string <- paste(\"colnames(\",ve.xls,\")[\",col,\"] <- '\",new_name,\"'\",sep=\"\")\n  eval(parse(text=cmd_string))\n} \n\nfrom.data.env <- function(ticker,field) {\n  #if (verbose) print(paste(\"from.data.env:\",\"ticker=\",ticker,\"field=\",field))\n  de.xls <- paste(\"data.env$\",ticker,\"$\",ticker,field,sep=\"\")\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  if (exists(ve.xls)) {\n    cmd_string <- paste(ve.xls,\" <- cbind(\",ve.xls,\",\",de.xls,\")\",sep=\"\")\n  } else {\n    cmd_string <- paste(ve.xls,\" <- \",de.xls,sep=\"\")\n  }\n  eval(parse(text=cmd_string))\n}\n\nfrom.var.env <- function(ticker,field) {\n  #if (verbose) print(paste(\"from.var.env:\",\"ticker=\",ticker,\"field=\",field))\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  ve.field <- paste(ve.xls,\"$\",field,sep=\"\")\n  cmd_string <- paste(ve.xls,\" <- cbind(\",ve.xls,\",\",ve.field,\")\",sep=\"\")\n  #if (verbose) print(cmd_string)\n  eval(parse(text=cmd_string))\n}\n\ncalc_lag <- function(ticker,lag=1) {  #always lag last column\n  #if (verbose) print(paste(\"calc_lag:\",\"ticker=\",ticker,\"lag=\",lag))\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  cmd_string <- paste(\"col <- ncol(\",ve.xls,\")\",sep=\"\")\n  eval(parse(text=cmd_string))\n  cmd_string <- paste(ve.xls,\"[,\",col,\"] <- stats::lag(\",ve.xls,\"[,\",col,\"],\",lag,\")\",sep=\"\")\n  #if (verbose) print(cmd_string)\n  eval(parse(text=cmd_string))\n}\n\ncalc_ret <- function(ticker,start_price,end_price) {\n  #if (verbose) print(paste(\"calc_ret:\",\"ticker=\",ticker,\"start_price=\",start_price,\"end_price=\",end_price))\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  start_field <- paste(ve.xls,\"$\",start_price,sep=\"\")\n  end_field <- paste(ve.xls,\"$\",end_price,sep=\"\")\n  cmd_string <- paste(ve.xls,\" <- cbind(\",ve.xls,\",log(\",end_field,\"/\",start_field,\"))\",sep=\"\")\n  #if (verbose) print(cmd_string)\n  eval(parse(text=cmd_string))\n}\n\ncalc_cap <- function(ticker,abscap=NULL) {  #always cap last column\n  #if (verbose) print(paste(\"calc_cp:\",\"ticker=\",ticker,\"abscap=\",abscap))\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  cmd_string <- paste(\"col <- ncol(\",ve.xls,\")\",sep=\"\")\n  eval(parse(text=cmd_string))\n  data_string <- paste(ve.xls,\"[,\",col,\"]\",sep=\"\")\n  cmd_string <- paste(data_string,\"[\",data_string,\" < \",-abscap,\"] <- \",-abscap,sep=\"\")\n  #if (verbose) print(cmd_string)\n  eval(parse(text=cmd_string))\n  cmd_string <- paste(data_string,\"[\",data_string,\" > \",abscap,\"] <- \",abscap,sep=\"\")\n  #if (verbose) print(cmd_string)\n  eval(parse(text=cmd_string))\n}\n\n#replace place holders XX0,XX1,..XXn with vars \n# XX0 represents last column, XX0N represents new column (can only be on right side)\n# XX1..XXn existing vars\n# math_str in the form 'XX0 <- f(XX0,XX1..XXn)' \ncalc_math <- function(ticker,XX_list=NULL,math_str) { #always apply math to last column\n  if (verbose) print(paste(\"ticker=\",ticker,\"XX_list=\",XX_list,\"math_str=\",math_str))\n  if (verbose) print(XX_list)\n  ve.xls <- paste(\"var.env$\",ticker,sep=\"\")\n  if (grepl(\"XX0N\",math_str)) {\n    place_holder_str <- \"XX0N\"\n    data_string <- 'tmp.xls'\n    new_var <- TRUE\n  } else {\n    place_holder_str <- \"XX0\"\n    cmd_string <- paste(\"col <- ncol(\",ve.xls,\")\",sep=\"\")\n    eval(parse(text=cmd_string))\n    data_string <- paste(ve.xls,\"[,\",col,\"]\",sep=\"\")\n    new_var <- FALSE\n  }\n  print (math_str)\n  print (data_string)\n  math_str <- gsub(place_holder_str,data_string,math_str)\n  print (math_str)\n  if (verbose) print(math_str)\n  if (!is.na(XX_list)) {\n    for (n in 1:length(XX_list)) {\n      data_string <- paste(ve.xls,\"[,'\",XX_list[n],\"']\",sep=\"\")\n      place_holder_str <- paste(\"XX\",n,sep=\"\")\n      print(data_string)\n      print(place_holder_str)\n      print(math_str)\n      math_str <- gsub(place_holder_str,data_string,math_str)\n      if (verbose) print(math_str)\n    }\n  }\n  eval(parse(text=math_str))\n  if (new_var) {\n    cmd_str <- paste(ve.xls,\" <- cbind(\",ve.xls,\",tmp.xls)\",sep=\"\")\n    if (verbose) print(cmd_str)\n    eval(parse(text=cmd_str))\n  }\n}\n\n\n",
    "created" : 1480453512105.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3475928289",
    "id" : "63A0E300",
    "lastKnownWriteTime" : 1480531962,
    "last_content_update" : 1480531962500,
    "path" : "~/XLF/p1/calc_lib.R",
    "project_path" : "calc_lib.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}